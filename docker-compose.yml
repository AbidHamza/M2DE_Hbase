services:
  hadoop:
    build:
      context: ./docker/hadoop
      dockerfile: Dockerfile
    container_name: hbase-hive-learning-lab-hadoop
    hostname: hadoop
    ports:
      - "9870:9870"   # NameNode Web UI
      - "8088:8088"   # ResourceManager Web UI
      - "9000:9000"   # HDFS
    environment:
      - HADOOP_HEAPSIZE=512
    volumes:
      - hadoop-data:/hadoop/dfs/name
      - hadoop-tmp:/tmp/hadoop
      - ./resources:/data/resources:ro
      - ./scripts:/opt/scripts:ro
    networks:
      - hbase-hive-network
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f NameNode > /dev/null && pgrep -f DataNode > /dev/null && hdfs dfsadmin -report 2>&1 | grep -q 'Live datanodes' || exit 1"]
      interval: 30s
      timeout: 20s
      retries: 8
      start_period: 180s

  zookeeper:
    image: zookeeper:3.7
    container_name: hbase-hive-learning-lab-zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181
    volumes:
      - zookeeper-data:/data
      - zookeeper-logs:/datalog
    networks:
      - hbase-hive-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  hbase:
    build:
      context: ./docker/hbase
      dockerfile: Dockerfile
    container_name: hbase-hive-learning-lab-hbase
    hostname: hbase
    depends_on:
      hadoop:
        condition: service_healthy
      zookeeper:
        condition: service_healthy
    restart: unless-stopped
    ports:
      # HBase Master Web UI - Port changé à 16011 pour éviter conflit Windows
      # Si 16011 est aussi bloqué, changez-le par un autre port libre (ex: 16012)
      - "16011:16010"  # HBase Master Web UI (port externe:interne)
      - "16020:16020"  # HBase RegionServer Web UI
      - "16030:16030"  # HBase REST API
    environment:
      - HBASE_HEAPSIZE=512
      - HADOOP_CONF_DIR=/opt/hadoop/etc/hadoop
      - HBASE_CONF_DIR=/opt/hbase/conf
      # JAVA_HOME is detected dynamically in start-hbase.sh and hbase-env.sh
    volumes:
      - hbase-data:/opt/hbase/data
      - ./resources:/data/resources:ro
    networks:
      - hbase-hive-network
    healthcheck:
      test: ["CMD", "/bin/bash", "/healthcheck.sh"]
      interval: 30s
      timeout: 20s
      retries: 12
      start_period: 180s

  hive:
    build:
      context: ./docker/hive
      dockerfile: Dockerfile
    container_name: hbase-hive-learning-lab-hive
    hostname: hive
    command: ["/bin/bash", "/start-hive.sh"]
    depends_on:
      hadoop:
        condition: service_healthy
      hbase:
        condition: service_healthy
      hive-metastore:
        condition: service_healthy
    ports:
      - "10000:10000"  # HiveServer2
      - "10002:10002"  # Hive Web UI
    environment:
      - HIVE_HOME=/opt/hive
      - HADOOP_HOME=/opt/hadoop
      - HIVE_SITE_CONF_hive_metastore_uris=thrift://hive-metastore:9083
      - HIVE_SITE_CONF_hive_metastore_warehouse_dir=/user/hive/warehouse
      - HIVE_SITE_CONF_hive_exec_scratchdir=/tmp/hive
      - JAVA_HOME=/opt/java/openjdk
    volumes:
      - hive-data:/opt/hive/warehouse
      - ./resources:/data/resources:ro
      - ./scripts:/opt/scripts:ro
    networks:
      - hbase-hive-network
    healthcheck:
      test: ["CMD", "hive", "--version"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s

  hive-metastore:
    build:
      context: ./docker/hive
      dockerfile: Dockerfile
    container_name: hbase-hive-learning-lab-hive-metastore
    hostname: hive-metastore
    command: ["/bin/bash", "/start-hive-metastore.sh"]
    depends_on:
      hadoop:
        condition: service_healthy
    environment:
      - HIVE_HOME=/opt/hive
      - HADOOP_HOME=/opt/hadoop
      - SERVICE_NAME=metastore
      - DB_DRIVER=derby
      - JAVA_HOME=/opt/java/openjdk
    volumes:
      - hive-metastore-data:/opt/hive/metastore_db
      - hive-metastore-logs:/opt/hive/logs
    networks:
      - hbase-hive-network
    healthcheck:
      test: ["CMD", "/bin/bash", "/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      retries: 8
      start_period: 120s

volumes:
  hadoop-data:
  hadoop-tmp:
  zookeeper-data:
  zookeeper-logs:
  hbase-data:
  hive-data:
  hive-metastore-data:
  hive-metastore-logs:

networks:
  hbase-hive-network:
    driver: bridge

